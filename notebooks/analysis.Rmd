---
title: "Exploration of USAPL Powerlifting Database Using R"
output: html_notebook
---
```{r}
library('tidyverse')
```

**1. Using the read_csv() function, read the datasets into your notebook.**
  - Comp_types = All USAPL competitions and their urls from USAPL website.
  - Usapl = Webscraped results from urls of USAPL competitions.
  - Us_states = List of 50 US States. 

```{r}
comp_types <- read_csv('../data/USAPL_competitions.csv', show_col_types = FALSE)
usapl <- read_csv('../data/usapl_update.csv', show_col_types = FALSE)
us_states <- read.delim('../data/us_states', header = TRUE)
```

**2. Do some exploratory data analysis.** 

How many unique meets are in usapl DataFrame? 
Some Meet Names are repeated every year so it makes sense if there's more sanction numbers than meet names. Some meets also don't have sanction numbers. Need to create a Unique Identification Number later. 
```{r}
length(unique(usapl$`Sanction Number`))
print(length(unique(usapl$`Meet Name`)))
length(unique(usapl$`Meet Date`))
```

How many unique meets are in comp_types DataFrame? 
```{r}
nrow(comp_types)
```

Rename columns in comp_types DF to match column names in usapl DF. 
```{r}
comp_types <- comp_types |> 
  rename(`Meet Date` = Date, `Meet Name` = Name, `Meet Location`= State)
```

**3. Compare usapl DataFrame to comp_types DataFrame. There are 3255 meet results in comp_types, but the distinct count in usapl does not match this.**

Missing_data_usapl is the DataFrame with rows containing information from meets in usapl DF but not found in comp_types DF. 
Why didn't these meets show up in the comp_types DF? 
```{r}
missing_data_usapl <- anti_join(usapl, comp_types, by = c("Meet Name", "Sanction Number"))

length(unique(missing_data_usapl$`Meet Name`))
print(unique(missing_data_usapl$`Meet Name`))
print(length(unique(missing_data_usapl$`Sanction Number`)))
print(unique(missing_data_usapl$`Sanction Number`))
```
What do the rows for these meets look like in the usapl DF? 
```{r}
missing_data_usapl |> 
  select(1:5) |> 
  unique()
```

Test to check if these meets are in the comp_types DF:
```{r}
comp_types |> 
  filter(`Meet Name` == "South Dakota State Championships")
```
Check if these meets are in usapl DF:
```{r}
usapl |> 
  filter(`Meet Name` == "South Dakota State Championships")
```

Search for empty Sanction Numbers column:
```{r}
usapl |> 
  filter(is.na(`Sanction Number`)) |> 
  distinct(`Meet Name`)
```

It looks like something may have gone wrong with the webscraping since these meets appear to show up in the both DF's, but it has missing rows of information in the usapl DF. 

*Explore why these meets are not showing properly in the usapl DF.*
1. Re-run webscraping Python code for these meets. 
2. Remove these meets from the usapl DF and concatenate the new webscraped results to usapl DF. 

**4. Extract meets from comp_types DF with urls that work and do not work.**

Missing_data_comp is the DataFrame with rows containing information from meets listed in comp_types DF but not found in usapl DF. 
```{r}
missing_data_comp <- anti_join(comp_types, usapl, by = c("Meet Name", "Meet Date", "Sanction Number"))

length(unique(missing_data_comp$`Meet Name`))
print(length(unique(missing_data_comp$`Meet Name`)))
```

Verify that missing_data_comp DF contains meets that are not listed in usapl DF:
```{r}
usapl |> 
  filter(`Meet Name` == "World Men's Classic Championships")
```
**5. Look for meets located in the US.** 
```{r}
us_meets <- comp_types |> 
  filter(`Meet Location` %in% us_states$Name)
```

How many meets are there in the US? 
There is a total of 3255 meets scraped from the USAPL website in comp_types DF. 96 meets are located outside of the US. 
```{r}
length(unique(us_meets$`Sanction Number`)) 
```

How many meets in comp_types have no Sanction Numbers? 

```{r}
comp_types |> 
  filter(is.na(`Sanction Number`)) |> 
  nrow() 
```
```{r}
comp_types |> 
  filter(is.na(`Sanction Number`)) |>
  distinct(`Meet Date`) |> 
  nrow()
```


When Sanction Number is empty and ...
  - Meet Type = IPF, use value in Meet Type. 
  - Meet Type = Local, use Meet Location and Date (state-year-month)
  - Meet Type = NAPF, use value in Meet Type. 
  - Meet Type = National, Meet Location and Date (state-year-month)
  - Meet Type = State, Meet Location and Date (state-year-month). 
```{r}
comp_types |> 
  filter(`Meet Type` == "State")
```


**6. Which US meets have normal-looking URLs? Which have faulty URLs?** 

In us_meets DF, extract the meets with urls that looks normal (contains "https://usapl.liftingdatabase.com/competitions-view"). How many meets are there? Some meets do not have a sanction number.  
```{r}
us_meets_good_url <- us_meets |>
  filter(grepl("https://usapl.liftingdatabase.com/competitions-view", Website))

nrow(us_meets_good_url)
length(unique(us_meets_good_url$`Sanction Number`))
```
Find the meets in US that has faulty url's. How many meets are there?
```{r}
us_meets_faulty_url <- us_meets |>
  filter(grepl("https://usapl.liftingdatabase.com/http://", Website))

nrow(us_meets_faulty_url)
length(unique(us_meets_faulty_url$`Sanction Number`))
```

Check us_meets_good_url DataFrame if it has any of the competitions listed in usapl. Verify with three random meets listed in usapl DF. 
```{r}
us_meets_good_url |> 
  filter(`Meet Name` == "Virginia Open State Championships")
```
**7. Extract these list of URLs to a csv for another attempt at webscraping the data**

Extract from us_meets_good_url DF: 
```{r}
only_good_urls <- us_meets_good_url |> 
  select(Website)

# write.csv(only_good_urls, 
#           "../data/only_good_urls.csv", 
#          row.names=FALSE )
```

Extract from us_meets_faulty_url DF: 
```{r}
us_meets_faulty_url$Website <- gsub("https://usapl.liftingdatabase.com/", 
                                    "", 
                                    us_meets_faulty_url$Website)

us_meets_faulty_url
```

**8. Check the comp_types DF to find the meets that did not have webscraped data**
```{r}
missing_data_comp_update <- anti_join(us_meets_good_url, usapl_merge, by = c("Meet Name", "Meet Date", "Sanction Number", "Meet Location"))

length(unique(missing_data_comp$`Meet Name`))
length(unique(missing_data_comp$`Meet Name`))
```

Extract these url's into another csv to be webscraped. 
```{r}
missing_data_urls <- missing_data_comp_update |>
  select(Website)

# write.csv(missing_data_urls,
#           "../data/missing_data_urls.csv",
#           row.names=FALSE)
```

**9. Import new webscraped DataFrames and merge them to combine ALL scraped data.**

Note: 
  - usapl_update.csv is a merged DF of two initial usapl DF's AND missingdata.csv. usapl_update.csv is current usapl DF. 
  - missingdata.csv is the result of webscraping missing_data_urls.csv 
  - missinginfo.csv is the result of updating retrieve_info function in Python code because these meets had a table[0] (meet_info table) with less than four tags. 

Import missinginfo.csv. 
```{r}
missinginfo <- read_csv('../data/missinginfo.csv', show_col_types = FALSE)
```

*To avoid duplication, remove the twenty meets that had missing info in the meet_info column types (meet info to meet director columns).* 

In missing_data_usapl DF, pull the names of each meet. 
```{r}
missing_info_names <- missing_data_usapl |> 
  distinct(`Meet Name`) |> 
  pull()
```

Filter the usapl DF for those meets using that list of names. 
Test:
```{r}
usapl |> 
  filter(`Meet Name` %in% missing_info_names) |> 
  filter(is.na(`Meet Date`))
```
Remove those meets from the usapl DF. 
```{r}
usapl <- usapl |> 
  filter(!(`Meet Name` %in% missing_info_names & is.na(`Meet Date`)))
```

Merge missinginfo DF with usapl DF:
```{r}
usapl_update <- unique(rbind(usapl, missinginfo))
```

Some meets have a different format for information in table[0]. Meet Location is a website. Search for 'http' in this column. 
```{r}
usapl_update |> 
  distinct(`Meet Location`)
```


Check how many unique meets are in this DF. There are 2966 meets in the US. I might have meets that do not have unique identification numbers, such as sanction numbers but are still located in the US. 
```{r}
length(unique(usapl$`Sanction Number`))
length(unique(usapl$`Meet Name`))
```

